<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>çµ±è¨ˆç³»çµ±</title>
  <style>
    body {
      font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
      background-color: #d6d6d6;
      padding: 20px;
      max-width: 900px;
      margin: 0 auto;
    }
    h1, h2 {
      color: #333;
      text-align: center;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .input-group {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }
    input, select, button, textarea {
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: inherit;
    }
    button {
      background-color: #81afa7;
      color: white;
      border: none;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background-color: #328779;
    }
    button.reset {
      background-color: #e8727e;
      margin-left: auto;
      display: block;
    }
    button.reset:hover {
      background-color: #891924;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
      font-size: 14px;
    }
    th {
      background-color: #a1a279;
      color: white;
    }
    tr:hover {
      background-color: #f1f1f1;
    }
    .total-box {
      font-size: 1.1em;
      font-weight: bold;
      text-align: right;
      color: #d9534f;
      margin-top: 10px;
    }
    .flex-row {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .flex-1 {
      flex: 1;
      min-width: 300px;
    }
    .btn-sm {
      padding: 4px 8px;
      font-size: 12px;
    }
    .btn-edit {
      background-color: #ffc107;
      color: #212529;
    }
    .btn-edit:hover {
      background-color: #e0a800;
    }
    .btn-delete {
      background-color: #e8727e;
    }
    .btn-delete:hover {
      background-color: #891924;
    }
  </style>
</head>
<body>

  <h1>ğŸ± çµ±è¨ˆå°ç¨‹å¼</h1>

  <!-- ç¬¬ä¸€æ­¥ï¼šè¨­å®šèœå–®å“é … -->
  <div class="card">
    <h2>â‘  è¨­å®šèœå–®å“é …ï¼ˆåç¨±ï¼‹é‡‘é¡ï¼‰</h2>

    <!-- æ‰‹å‹•æ–°å¢å“é … -->
    <div class="input-group">
      <input
        type="text"
        id="menuNameInput"
        placeholder="è¼¸å…¥å“é …åç¨±ï¼ˆä¾‹ï¼šæ’éª¨é£¯ï¼‰"
        autocomplete="off"
      >
      <input
        type="number"
        id="menuPriceInput"
        placeholder="å–®åƒ¹ï¼ˆå…ƒï¼‰"
        min="0"
        style="width: 120px;"
      >
      <button id="addMenuItemBtn">â• æ–°å¢å“é …</button>
      <button id="clearMenuBtn" class="btn-delete">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰å“é …</button>
    </div>

    <!-- åŸå§‹æ–‡å­—è²¼ä¸Šï¼ˆæ•´é è¤‡è£½ç”¨ï¼‰ -->
    <div style="margin-top:12px;">
      <label style="font-size:14px; display:block; margin-bottom:4px;">
        å¾ UberEats / å…¶ä»–ç¶²ç«™æ•´é è¤‡è£½çš„æ–‡å­—ï¼Œè²¼åœ¨é€™è£¡ï¼ˆæˆ‘æœƒå¹«ä½ æ•´ç†å‡º å“é …+é‡‘é¡ï¼‰ï¼š
      </label>
      <textarea
        id="rawTextInput"
        rows="4"
        style="width:100%; font-size:14px; padding:8px;"
        placeholder="åœ¨åº—å®¶é é¢ âŒ˜+A å…¨é¸ â†’ âŒ˜+C è¤‡è£½ â†’ è²¼åˆ°é€™è£¡ï¼Œå†æŒ‰ã€æ•´ç†æˆèœå–®æ–‡å­—ã€"
      ></textarea>
      <div style="margin-top:8px; text-align:right;">
        <button type="button" id="parseRawBtn">ğŸ§¹ æ•´ç†æˆèœå–®æ–‡å­—</button>
      </div>
    </div>

    <!-- åŒ¯å…¥èœå–®æ–‡å­—ï¼ˆæ¯è¡Œï¼šå“é …,é‡‘é¡ï¼‰ -->
    <div style="margin-top:12px;">
      <label style="font-size:14px; display:block; margin-bottom:4px;">
        æˆ–å¿«é€ŸåŒ¯å…¥ï¼ˆæ¯è¡Œï¼šå“é …,é‡‘é¡ï¼‰ï¼š
      </label>
      <textarea
        id="menuImportInput"
        rows="4"
        style="width:100%; font-size:14px; padding:8px;"
        placeholder="ä¾‹å¦‚ï¼š
æ’éª¨é£¯,100
é›è…¿é£¯,120
ç´…èŒ¶,30"
      ></textarea>
      <div style="margin-top:8px; text-align:right;">
        <button type="button" id="importMenuBtn">â¬ åŒ¯å…¥èœå–®æ–‡å­—</button>
      </div>
    </div>

    <table id="menuTable">
      <thead>
        <tr>
          <th>#</th>
          <th>å“é …åç¨±</th>
          <th>å–®åƒ¹</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- ç¬¬äºŒæ­¥ï¼šè¼¸å…¥è¨‚å–®ï¼ˆé¸å§“åï¼‹å“é …ï¼‹ä»½æ•¸ï¼‰ -->
  <div class="card">
    <h2>â‘¡ è¼¸å…¥è¨‚å–®ï¼ˆé¸æ“‡å§“åèˆ‡å“é …ï¼‰</h2>
    <div class="input-group">
      <input
        type="text"
        id="username"
        placeholder="è¼¸å…¥å§“å (ä¾‹å¦‚: å°æ˜)"
        autocomplete="off"
      >
      <select id="menuSelect">
        <!-- ç”± JS ä¾ç…§èœå–®è‡ªå‹•ç”¢ç”Ÿ -->
      </select>
      <input
        type="number"
        id="qtyInput"
        min="1"
        value="1"
        style="width:80px;"
        placeholder="ä»½æ•¸"
      >
      <button id="addOrderBtn" disabled>â• åŠ å…¥è¨‚å–®</button>
    </div>

    <!-- å¾è³¼ç‰©è»Šè²¼æ–‡å­—è‡ªå‹•åŒ¯å…¥ -->
    <div style="margin-top:16px;">
      <h2 style="font-size:18px; text-align:left; margin-bottom:6px;">â‘¢ å¾è³¼ç‰©è»Šæ–‡å­—è‡ªå‹•åŒ¯å…¥è¨‚å–®</h2>
      <p style="font-size:13px; color:#555; margin-top:0;">
        åœ¨ UberEats è¨‚å–®ç•«é¢ï¼šé•·æŒ‰æ–‡å­— â†’ å…¨é¸ â†’ è¤‡è£½ï¼Œè²¼åˆ°ä¸‹æ–¹ï¼Œå†æŒ‰ã€Œè§£æè³¼ç‰©è»Šæ–‡å­—ã€å³å¯ã€‚
      </p>
      <textarea
        id="cartTextInput"
        rows="6"
        style="width:100%; font-size:14px; padding:8px;"
        placeholder="ä¾‹ï¼š
è¨ªå®¢1
æ­£åœ¨æ–°å¢å•†å“ãƒ»1 ä»½é¤é»

1
é‡èœèœœæ±ç‡’è‚‰å¹«ç±³çŸ­æ³•
$200.00
åŠ è¾£é¸æ“‡
å¤§è¾£
åŠ æ–™é¸æ“‡ ($65.00)
æ²™å—²ç‰›"
      ></textarea>
      <div style="margin-top:8px; text-align:right;">
        <button type="button" id="parseCartBtn">ğŸ§¾ è§£æè³¼ç‰©è»Šæ–‡å­—ä¸¦åŠ å…¥è¨‚å–®</button>
      </div>
    </div>
  </div>

  <!-- è¨‚å–®æ˜ç´° -->
  <div class="card">
    <h2>ğŸ“ è¨‚å–®æ˜ç´°ï¼ˆå¯ä¿®æ”¹ / åˆªé™¤ï¼‰</h2>
    <table id="orderTable">
      <thead>
        <tr>
          <th>#</th>
          <th>å§“å</th>
          <th>å“é …</th>
          <th>å–®åƒ¹</th>
          <th>æ•¸é‡</th>
          <th>å°è¨ˆ</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- ç¸½è¨ˆæ¦‚æ³ -->
  <div class="card">
    <h2>ğŸ“Š ç¸½è¨ˆæ¦‚æ³</h2>
    <div class="total-box" id="grandTotalDisplay">
      ç›®å‰å°šæœªé»é¤
    </div>
  </div>

  <!-- çµ±è¨ˆå€ï¼šäººå“¡çµ±è¨ˆï¼ˆç¨ç«‹ä¸€æ•´æ’ï¼‰ -->
  <div class="card">
    <h2>ğŸ‘¤ è³¼ç‰©è»Šçµ±è¨ˆ (èª°é»äº†ä»€éº¼)</h2>

    <!-- æŠ˜æ‰£è¨­å®š -->
    <div class="input-group" style="justify-content:flex-end; margin-bottom:8px;">
      <label style="font-size:14px;">
        æŠ˜æ‰£ï¼š
        <input
          type="number"
          id="discountInput"
          min="0"
          max="100"
          value="50"
          style="width:70px;"
        > %
        <span style="color:#666; font-size:12px;">ï¼ˆ100=ä¸æ‰“æŠ˜ã€90=ä¹æŠ˜ï¼‰</span>
      </label>
    </div>

    <table id="personTable">
      <thead>
        <tr>
          <th>å§“å</th>
          <th>å“é …å…§å®¹</th>
          <th>ç¸½ä»½æ•¸</th>
          <th>ç¸½é‡‘é¡</th>
          <th>æŠ˜æ‰£å¾Œé‡‘é¡</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- çµ±è¨ˆå€ï¼šé¤é»çµ±è¨ˆï¼ˆå¦å¤–ä¸€æ•´æ’ï¼‰ -->
  <div class="card">
    <h2>ğŸ— é¤é»çµ±è¨ˆ (åº—å®¶å«è²¨ç”¨)</h2>
    <table id="itemTable">
      <thead>
        <tr>
          <th>å“é …åç¨±</th>
          <th>ç¸½æ•¸é‡</th>
          <th>ç¸½é‡‘é¡</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <button class="reset" id="resetBtn">âš ï¸ æ¸…é™¤æ‰€æœ‰è¨‚å–®é‡ä¾†ï¼ˆèœå–®ä¿ç•™ï¼‰</button>

  <script>
    (() => {
      'use strict';

      // èœå–®è³‡æ–™ï¼šæ¯ç­† {name, price}
      const menuItems = [];
      // è¨‚å–®è³‡æ–™ï¼šæ¯ç­† {name, item, price, qty, detail}
      // detail ç”¨ä¾†æ”¾ï¼šåŠ è¾£ã€åŠ æ–™ã€å‚™è¨»ç­‰ï¼ˆä¾‹å¦‚ï¼šå¾®è¾£ / ä¸åŠ é¦™èœ / æ²™å—²ç‰› +65ï¼‰
      const orders = [];

      let editingIndex = -1;      // è¨‚å–®æ˜¯å¦åœ¨ç·¨è¼¯ä¸­
      let menuEditingIndex = -1;  // èœå–®æ˜¯å¦åœ¨ç·¨è¼¯ä¸­

      // DOM å…ƒç´  --------------------------------
      const menuNameInput   = document.getElementById('menuNameInput');
      const menuPriceInput  = document.getElementById('menuPriceInput');
      const addMenuItemBtn  = document.getElementById('addMenuItemBtn');
      const clearMenuBtn    = document.getElementById('clearMenuBtn');
      const rawTextInput    = document.getElementById('rawTextInput');
      const parseRawBtn     = document.getElementById('parseRawBtn');
      const menuImportInput = document.getElementById('menuImportInput');
      const importMenuBtn   = document.getElementById('importMenuBtn');
      const menuTbody       = document.querySelector('#menuTable tbody');
      const menuSelect      = document.getElementById('menuSelect');

      const nameInput       = document.getElementById('username');
      const qtyInput        = document.getElementById('qtyInput');
      const addOrderBtn     = document.getElementById('addOrderBtn');
      const resetBtn        = document.getElementById('resetBtn');

      const cartTextInput   = document.getElementById('cartTextInput');
      const parseCartBtn    = document.getElementById('parseCartBtn');

      const orderTbody      = document.querySelector('#orderTable tbody');
      const grandTotalEl    = document.getElementById('grandTotalDisplay');
      const personTbody     = document.querySelector('#personTable tbody');
      const itemTbody       = document.querySelector('#itemTable tbody');

      const discountInput   = document.getElementById('discountInput');

      // å·¥å…·ï¼šå››æ¨äº”å…¥ï¼ˆ0.5 å°± +1ï¼‰
      function roundHalfUp(value) {
        return Math.floor(value + 0.5);
      }

      // äº‹ä»¶ç¶å®š --------------------------------
      addMenuItemBtn.addEventListener('click', handleSubmitMenuItem);
      menuPriceInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') handleSubmitMenuItem();
      });

      importMenuBtn.addEventListener('click', handleImportMenu);
      parseRawBtn.addEventListener('click', handleParseRawText);

      clearMenuBtn.addEventListener('click', () => {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰èœå–®å“é …å—ï¼Ÿï¼ˆä¸å½±éŸ¿å·²å»ºç«‹çš„è¨‚å–®ï¼‰')) return;
        menuItems.length = 0;
        menuEditingIndex = -1;
        resetMenuForm();
        renderMenu();
      });

      addOrderBtn.addEventListener('click', handleSubmitOrder);
      nameInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') handleSubmitOrder();
      });
      qtyInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') handleSubmitOrder();
      });

      discountInput.addEventListener('input', () => {
        renderAll();
      });

      resetBtn.addEventListener('click', () => {
        if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è¨‚å–®å—ï¼Ÿèœå–®å“é …æœƒä¿ç•™ã€‚')) return;
        orders.length = 0;
        editingIndex = -1;
        resetOrderForm();
        renderAll();
      });

      menuTbody.addEventListener('click', (e) => {
        const target = e.target;
        if (!(target instanceof HTMLElement)) return;

        const indexStr = target.dataset.index;
        if (indexStr == null) return;
        const index = Number(indexStr);
        if (Number.isNaN(index)) return;

        if (target.classList.contains('btn-menu-edit')) {
          startEditMenuItem(index);
        } else if (target.classList.contains('btn-menu-delete')) {
          if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å“é …å—ï¼Ÿï¼ˆå·²ä¸‹å–®çš„ä¸æœƒè¢«åˆªé™¤ï¼‰')) return;
          menuItems.splice(index, 1);
          if (menuEditingIndex === index) {
            menuEditingIndex = -1;
            resetMenuForm();
          }
          renderMenu();
        }
      });

      orderTbody.addEventListener('click', (e) => {
        const target = e.target;
        if (!(target instanceof HTMLElement)) return;

        const idxStr = target.dataset.index;
        if (idxStr == null) return;
        const index = Number(idxStr);
        if (Number.isNaN(index)) return;

        if (target.classList.contains('btn-edit')) {
          startEditOrder(index);
        } else if (target.classList.contains('btn-delete')) {
          deleteOrder(index);
        }
      });

      parseCartBtn.addEventListener('click', handleParseCartOrders);

      // å…±ç”¨åˆ¤æ–·å‡½å¼ ------------------------------
      function isCartNameLine(line) {
        if (!line) return false;
        if (line.includes('æ‚¨æœ¬äºº')) return true;
        if (/^è¨ªå®¢\d+/.test(line)) return true;
        return false;
      }

      function isQtyLine(lines, idx) {
        const l = lines[idx];
        if (!/^\d+$/.test(l)) return false;
        const next = lines[idx + 1] || '';
        const priceLine = lines[idx + 2] || '';
        if (!next) return false;
        if (!/\$[0-9]/.test(priceLine)) return false;
        return true;
      }

      function isBoundaryLine(line) {
        if (!line) return false;
        if (isCartNameLine(line)) return true;
        if (/ä»½é¤é»/.test(line)) return true;
        return false;
      }

      // è§£æè³¼ç‰©è»Šæ–‡å­—æˆè¨‚å–®ç‰©ä»¶é™£åˆ— ----------------
      function parseCartTextToOrders(text) {
        const rawLines = text.split(/\r?\n/);
        const lines = rawLines.map(l => l.trim()).filter(l => l.length);
        const result = [];
        let currentName = null;

        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];

          // å§“åè¡Œï¼šè¨ªå®¢1ã€èå©· (æ‚¨æœ¬äºº)
          if (isCartNameLine(line)) {
            currentName = line.replace(/\s*\(æ‚¨æœ¬äºº\)\s*/, '');
            continue;
          }

          // ã€Œæ­£åœ¨æ–°å¢å•†å“ãƒ»1 ä»½é¤é»ã€ä¹‹é¡
          if (/ä»½é¤é»/.test(line)) continue;

          // æ•¸é‡è¡Œ
          if (isQtyLine(lines, i)) {
            const qty = parseInt(lines[i], 10) || 1;
            const itemName = lines[i + 1] || '';
            const priceLine = lines[i + 2] || '';
            const m = priceLine.match(/\$([0-9.,]+)/);
            const basePrice = m ? parseFloat(m[1].replace(/,/g, '')) : 0;

            let j = i + 3;
            let detailParts = [];
            let extraPriceTotal = 0;

            while (j < lines.length) {
              const l2 = lines[j];

              if (isBoundaryLine(l2) || isQtyLine(lines, j)) break;

              // åŠ è¾£é¸æ“‡ + ä¸‹ä¸€è¡Œï¼ˆå°è¾£ / å¤§è¾£ï¼‰
              if (l2.includes('åŠ è¾£é¸æ“‡')) {
                const level = lines[j + 1] || '';
                if (level) detailParts.push(`åŠ è¾£ï¼š${level}`);
                j += 2;
                continue;
              }

              // åŠ æ–™é¸æ“‡ ($65.00) + ä¸‹ä¸€è¡Œï¼ˆæ²™å—²ç‰›ï¼‰
              const addonMatch = l2.match(/åŠ æ–™é¸æ“‡.*\(\$([0-9.,]+)\)/);
              if (addonMatch) {
                const addonPrice = parseFloat(addonMatch[1].replace(/,/g, '')) || 0;
                const addonName = lines[j + 1] || '';
                extraPriceTotal += addonPrice;
                if (addonName) {
                  detailParts.push(`åŠ æ–™ï¼š${addonName} +${addonPrice}`);
                } else {
                  detailParts.push(`åŠ æ–™ +${addonPrice}`);
                }
                j += 2;
                continue;
              }

              // å‚™è¨»ï¼šä¸åŠ é¦™èœ
              if (/^å‚™è¨»/.test(l2)) {
                detailParts.push(l2);
                j++;
                continue;
              }

              j++;
            }

            const totalPrice = Math.round(basePrice + extraPriceTotal);
            const detail = detailParts.join(' / ');
            const name = currentName || 'æœªå‘½å';

            result.push({
              name,
              item: itemName,
              price: totalPrice,
              qty,
              detail
            });

            i = j - 1; // è·³åˆ°é€™å€‹ block çµå°¾
          }
        }

        return result;
      }

      // åŠŸèƒ½ï¼šèœå–® --------------------------------
      function handleSubmitMenuItem() {
        const name = menuNameInput.value.trim();
        const price = Number(menuPriceInput.value);

        if (!name) {
          alert('è«‹è¼¸å…¥å“é …åç¨±ï¼');
          menuNameInput.focus();
          return;
        }
        if (Number.isNaN(price) || price < 0) {
          alert('è«‹è¼¸å…¥æ­£ç¢ºçš„å–®åƒ¹ï¼ˆ>=0ï¼‰ï¼');
          menuPriceInput.focus();
          return;
        }

        if (menuEditingIndex === -1) {
          // æ–°å¢æ¨¡å¼
          menuItems.push({ name, price });
        } else {
          // ç·¨è¼¯æ¨¡å¼ï¼šæ›´æ–°èœå–®ï¼Œä¸¦åŒæ­¥æ›´æ–°å·²å­˜åœ¨çš„è¨‚å–®
          const oldItem = menuItems[menuEditingIndex];
          const oldName = oldItem.name;
          const oldPrice = oldItem.price;

          menuItems[menuEditingIndex] = { name, price };

          for (const o of orders) {
            if (o.item === oldName && o.price === oldPrice) {
              o.item = name;
              o.price = price;
            }
          }

          menuEditingIndex = -1;
        }

        resetMenuForm();
        renderMenu();
        renderAll();
      }

      function handleImportMenu() {
        const text = menuImportInput.value.trim();
        if (!text) {
          alert('è«‹å…ˆåœ¨ã€ŒåŒ¯å…¥èœå–®æ–‡å­—ã€å€è²¼ä¸Šå…§å®¹ã€‚');
          return;
        }

        const lines = text.split('\n');
        let addedCount = 0;

        for (const raw of lines) {
          const line = raw.trim();
          if (!line) continue;

          const parts = line.split(/[,ï¼Œ\t]/);
          if (parts.length < 2) continue;

          const name = parts[0].trim();
          const priceStr = parts[1].trim();
          const price = Number(priceStr);

          if (!name || Number.isNaN(price)) continue;

          menuItems.push({ name, price });
          addedCount++;
        }

        if (addedCount === 0) {
          alert('åŒ¯å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªæ¯è¡Œæ ¼å¼ç‚ºï¼šå“é …,é‡‘é¡ ä¾‹å¦‚ã€Œæ’éª¨é£¯,100ã€ã€‚');
          return;
        }

        alert(`å·²åŒ¯å…¥ ${addedCount} ç­†å“é …ã€‚`);
        menuImportInput.value = '';
        menuEditingIndex = -1;
        resetMenuForm();
        renderMenu();
      }

      // ğŸ”¹ å¾åŸå§‹æ•´é æ–‡å­—è§£æå‡ºã€Œå“é …,é‡‘é¡ã€åˆ—è¡¨ï¼ˆåº—å®¶èœå–®ï¼‰
      function handleParseRawText() {
        const text = rawTextInput.value.trim();
        if (!text) {
          alert('è«‹å…ˆæŠŠ UberEats / ç¶²é æ•´é æ–‡å­—è²¼åˆ°ä¸Šé¢çš„æ¡†æ¡†ã€‚');
          return;
        }

        const lines = text.split(/\r?\n/)
          .map(l => l.trim())
          .filter(Boolean);

        const blacklist = /å¤–é€|å¤–é€è²»|å¤–å¸¶|æœå‹™è²»|é‹è²»|å…é‹|å„ªæƒ |æŠ˜æ‰£|å¸¸è¦‹å•é¡Œ|Uber Eats|ç¨…é‡‘|ç¨…è²»|è¨‚å–®|è©•è«–|è©•åˆ†|ä½¿ç”¨æ¢æ¬¾|éš±ç§|æ”¯æ´|å®¢æœ|ç™»å…¥|è¨»å†Š|èªè¨€|ç‰ˆæ¬Š|Copyright|æ‚¨å°ˆå±¬çš„æ¨è–¦å•†å“/i;

        const priceRegex = /(NT\$|\$|ï¼„)\s*([0-9][0-9.,]*)/;

        const results = [];
        const seen = new Set();

        function looksLikeName(str) {
          if (!str) return false;
          if (priceRegex.test(str)) return false;
          if (blacklist.test(str)) return false;
          if (/^\d+(\.\d+)?\s*%/.test(str)) return false;       // 95%
          if (/^\d+\s*\(.*\)$/.test(str)) return false;         // 497 (xxx)
          if (/^[â€¢Â·\-\s]+$/.test(str)) return false;            // åªæœ‰ç¬¦è™Ÿ
          if (!/[\u4e00-\u9fffA-Za-z]/.test(str)) return false; // è‡³å°‘è¦æœ‰ä¸­æ–‡å­—æˆ–è‹±æ–‡
          return true;
        }

        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          const m = line.match(priceRegex);
          if (!m) continue;
          if (blacklist.test(line)) continue;

          let priceStr = m[2].replace(/[^\d.]/g, '');
          if (!priceStr) continue;
          let priceNum = parseFloat(priceStr);
          if (Number.isNaN(priceNum)) continue;
          const price = Math.round(priceNum);

          let name = null;

          // å¾€ä¸Šæ‰¾å“å
          for (let j = i - 1; j >= 0; j--) {
            const cand = lines[j];
            if (looksLikeName(cand)) {
              name = cand.trim();
              break;
            }
          }

          // è‹¥å¾€ä¸Šæ²’æ‰¾åˆ°ï¼Œå¾€ä¸‹æ‰¾ä¸€æ¬¡ï¼ˆå‚™æ´ï¼‰
          if (!name) {
            for (let j = i + 1; j < lines.length; j++) {
              const cand = lines[j];
              if (looksLikeName(cand)) {
                name = cand.trim();
                break;
              }
            }
          }

          if (!name) continue;

          const key = `${name}|${price}`;
          if (seen.has(key)) continue;
          seen.add(key);

          results.push(`${name},${price}`);
        }

        if (!results.length) {
          alert('æ²’æœ‰è§£æåˆ°ä»»ä½•ã€Œå“é …ï¼‹é‡‘é¡ã€ã€‚å¯èƒ½è©²é é¢æ ¼å¼æ¯”è¼ƒç‰¹åˆ¥ï¼Œæˆ–å°šæœªæŠŠèœå–®å…¨éƒ¨æ»‘å‡ºä¾†ã€‚');
          return;
        }

        menuImportInput.value = results.join('\n');
        alert(`å·²å¾åŸå§‹æ–‡å­—æ•´ç†å‡º ${results.length} ç­†å“é …ï¼Œè«‹ç¢ºèªå¾ŒæŒ‰ã€Œâ¬ åŒ¯å…¥èœå–®æ–‡å­—ã€ã€‚`);
      }

      function startEditMenuItem(index) {
        const item = menuItems[index];
        menuEditingIndex = index;

        menuNameInput.value = item.name;
        menuPriceInput.value = item.price;
        addMenuItemBtn.textContent = 'ğŸ’¾ å„²å­˜å“é …ä¿®æ”¹';
        menuNameInput.focus();
      }

      function resetMenuForm() {
        menuNameInput.value = '';
        menuPriceInput.value = '';
        addMenuItemBtn.textContent = 'â• æ–°å¢å“é …';
      }

      function renderMenu() {
        if (menuItems.length === 0) {
          menuTbody.innerHTML =
            '<tr><td colspan="4" style="text-align:center;color:#888;">å°šç„¡å“é …ï¼Œè«‹å…ˆæ–°å¢ã€‚</td></tr>';
        } else {
          const rows = menuItems.map((m, index) => `
            <tr>
              <td>${index + 1}</td>
              <td>${m.name}</td>
              <td>$${m.price}</td>
              <td>
                <button type="button" class="btn-sm btn-edit btn-menu-edit" data-index="${index}">ä¿®æ”¹</button>
                <button type="button" class="btn-sm btn-delete btn-menu-delete" data-index="${index}">åˆªé™¤</button>
              </td>
            </tr>
          `);
          menuTbody.innerHTML = rows.join('');
        }

        menuSelect.innerHTML = '';
        if (menuItems.length === 0) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'è«‹å…ˆåœ¨ä¸Šæ–¹æ–°å¢å“é …';
          opt.disabled = true;
          opt.selected = true;
          menuSelect.appendChild(opt);
          addOrderBtn.disabled = true;
        } else {
          addOrderBtn.disabled = false;
          menuItems.forEach((m) => {
            const opt = document.createElement('option');
            opt.value = `${m.name}|${m.price}`;
            opt.textContent = `${m.name} ($${m.price})`;
            menuSelect.appendChild(opt);
          });
        }
      }

      // åŠŸèƒ½ï¼šè¨‚å–® --------------------------------
      function handleSubmitOrder() {
        const name = nameInput.value.trim();
        const qty = parseInt(qtyInput.value, 10);

        if (!name) {
          alert('è«‹è¼¸å…¥å§“åï¼');
          nameInput.focus();
          return;
        }
        if (menuItems.length === 0 || !menuSelect.value) {
          alert('è«‹å…ˆåœ¨ç¬¬ä¸€æ­¥é©Ÿæ–°å¢å“é …ï¼');
          return;
        }
        if (Number.isNaN(qty) || qty <= 0) {
          alert('è«‹è¼¸å…¥æ­£ç¢ºçš„ä»½æ•¸ï¼ˆ>=1ï¼‰ï¼');
          qtyInput.focus();
          return;
        }

        const [itemName, itemPrice] = menuSelect.value.split('|');
        const price = Number(itemPrice);
        if (!itemName || Number.isNaN(price)) {
          alert('å“é …è³‡æ–™æœ‰èª¤ï¼Œè«‹é‡æ–°é¸æ“‡ã€‚');
          return;
        }

        // è‹¥æ˜¯ç·¨è¼¯æ¨¡å¼ï¼Œä¿ç•™åŸæœ¬çš„ detailï¼ˆåŠ æ–™/å‚™è¨»ç­‰ï¼‰
        let detail = '';
        if (editingIndex !== -1 && orders[editingIndex]) {
          detail = orders[editingIndex].detail || '';
        }

        const newOrder = {
          name,
          item: itemName,
          price,
          qty,
          detail
        };

        if (editingIndex === -1) {
          const existIndex = orders.findIndex(
            o => o.name === newOrder.name &&
                 o.item === newOrder.item &&
                 o.price === newOrder.price &&
                 (o.detail || '') === (newOrder.detail || '')
          );
          if (existIndex >= 0) {
            orders[existIndex].qty += newOrder.qty;
          } else {
            orders.push(newOrder);
          }
        } else {
          orders[editingIndex] = newOrder;
          mergeDuplicateOrders();
        }

        editingIndex = -1;
        resetOrderForm();
        renderAll();
      }

      // å¾è³¼ç‰©è»Šæ–‡å­—è§£æï¼ŒåŠ å…¥ orders -----------------
      function handleParseCartOrders() {
        const text = cartTextInput.value.trim();
        if (!text) {
          alert('è«‹å…ˆæŠŠè³¼ç‰©è»Šæ•´æ®µæ–‡å­—è²¼ä¸Šã€‚');
          return;
        }

        const parsedOrders = parseCartTextToOrders(text);
        if (!parsedOrders.length) {
          alert('æ²’æœ‰è§£æåˆ°ä»»ä½•é¤é»ï¼Œå¯èƒ½è³¼ç‰©è»Šæ ¼å¼è·Ÿé æœŸä¸åŒã€‚');
          return;
        }

        for (const o of parsedOrders) {
          // è‹¥èœå–®å°šæœªæœ‰æ­¤å“é …ï¼Œé †ä¾¿åŠ åˆ°èœå–®ï¼Œä¹‹å¾Œæ¯”è¼ƒå¥½ç·¨è¼¯
          const menuIdx = menuItems.findIndex(
            m => m.name === o.item && m.price === o.price
          );
          if (menuIdx === -1) {
            menuItems.push({ name: o.item, price: o.price });
          }

          const existIndex = orders.findIndex(
            x => x.name === o.name &&
                 x.item === o.item &&
                 x.price === o.price &&
                 (x.detail || '') === (o.detail || '')
          );
          if (existIndex >= 0) {
            orders[existIndex].qty += o.qty;
          } else {
            orders.push(o);
          }
        }

        mergeDuplicateOrders();
        renderMenu();
        renderAll();
        alert(`å·²å¾è³¼ç‰©è»Šè§£æå‡º ${parsedOrders.length} ç­†é¤é»ï¼Œå·²åŠ å…¥è¨‚å–®ã€‚`);
        cartTextInput.value = '';
      }

      function mergeDuplicateOrders() {
        const map = {};
        for (const o of orders) {
          const key = `${o.name}|${o.item}|${o.price}|${o.detail || ''}`;
          if (!map[key]) {
            map[key] = { ...o };
          } else {
            map[key].qty += o.qty;
          }
        }
        const merged = Object.values(map);
        orders.length = 0;
        orders.push(...merged);
      }

      function startEditOrder(index) {
        const o = orders[index];
        editingIndex = index;

        nameInput.value = o.name;
        qtyInput.value = o.qty;
        menuSelect.value = `${o.item}|${o.price}`;

        addOrderBtn.textContent = 'ğŸ’¾ å„²å­˜ä¿®æ”¹';
        nameInput.focus();
      }

      function deleteOrder(index) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç­†è¨‚å–®å—ï¼Ÿ')) return;
        orders.splice(index, 1);
        editingIndex = -1;
        resetOrderForm();
        renderAll();
      }

      function resetOrderForm() {
        // è‹¥ä¸æƒ³ä¿ç•™ä¸Šä¸€å€‹äººåï¼Œå¯å–æ¶ˆè¨»è§£ä¸‹ä¸€è¡Œ
        // nameInput.value = '';
        qtyInput.value = 1;
        addOrderBtn.textContent = 'â• åŠ å…¥è¨‚å–®';
      }

      // ç•«é¢æ¸²æŸ“ --------------------------------
      function renderOrderTable() {
        if (orders.length === 0) {
          orderTbody.innerHTML =
            '<tr><td colspan="7" style="text-align:center;color:#888;">å°šç„¡è¨‚å–®</td></tr>';
          return;
        }

        const rows = orders.map((o, index) => {
          const subtotal = o.qty * o.price;
          const detailHtml = o.detail
            ? `<br><span style="font-size:12px;color:#666;">${o.detail}</span>`
            : '';
          return `
            <tr>
              <td>${index + 1}</td>
              <td>${o.name}</td>
              <td>${o.item}${detailHtml}</td>
              <td>$${o.price}</td>
              <td>${o.qty}</td>
              <td>$${subtotal}</td>
              <td>
                <button type="button" class="btn-sm btn-edit" data-index="${index}">ä¿®æ”¹</button>
                <button type="button" class="btn-sm btn-delete" data-index="${index}">åˆªé™¤</button>
              </td>
            </tr>
          `;
        });

        orderTbody.innerHTML = rows.join('');
      }

      function renderStats() {
        const personStats = {};
        const itemStats = {};
        let grandTotalQty = 0;
        let grandTotalMoney = 0;

        if (orders.length === 0) {
          grandTotalEl.textContent = 'ç›®å‰å°šæœªé»é¤';
          personTbody.innerHTML = '';
          itemTbody.innerHTML = '';
          return;
        }

        for (const o of orders) {
          const subtotal = o.qty * o.price;
          grandTotalQty   += o.qty;
          grandTotalMoney += subtotal;

          if (!personStats[o.name]) {
            personStats[o.name] = { items: [], total: 0, count: 0 };
          }
          const p = personStats[o.name];

          const itemText = o.detail
            ? `${o.item} x${o.qty}ï¼ˆ${o.detail}ï¼‰`
            : `${o.item} x${o.qty}`;
          p.items.push(itemText);
          p.total += subtotal;
          p.count += o.qty;

          if (!itemStats[o.item]) {
            itemStats[o.item] = { count: 0, total: 0 };
          }
          const it = itemStats[o.item];
          it.count += o.qty;
          it.total += subtotal;
        }

        grandTotalEl.innerHTML =
          `ç¸½ä»½æ•¸: ${grandTotalQty} ä»½&nbsp;&nbsp;|&nbsp;&nbsp;ç¸½é‡‘é¡: $${grandTotalMoney}`;

        let discountPercent = Number(discountInput.value);
        if (Number.isNaN(discountPercent) || discountPercent < 0) discountPercent = 100;
        if (discountPercent > 100) discountPercent = 100;
        const discountFactor = discountPercent / 100;

        const personEntries = Object.entries(personStats).sort(
          ([a], [b]) => a.localeCompare(b, 'zh-Hant')
        );
        personTbody.innerHTML = personEntries.map(([name, data]) => {
          const discountedRaw = data.total * discountFactor;
          const discounted    = roundHalfUp(discountedRaw);

          return `
            <tr>
              <td>${name}</td>
              <td style="font-size:0.9em;color:#666;">${data.items.join('ã€')}</td>
              <td>${data.count}</td>
              <td style="color:#d9534f;font-weight:bold;">$${data.total}</td>
              <td style="color:#28a745;font-weight:bold;">$${discounted}</td>
            </tr>
          `;
        }).join('');

        const itemEntries = Object.entries(itemStats).sort(
          ([a], [b]) => a.localeCompare(b, 'zh-Hant')
        );
        itemTbody.innerHTML = itemEntries.map(([itemName, data]) => `
          <tr>
            <td>${itemName}</td>
            <td style="font-weight:bold;">${data.count}</td>
            <td>$${data.total}</td>
          </tr>
        `).join('');
      }

      function renderAll() {
        renderOrderTable();
        renderStats();
      }

      // åˆå§‹åŒ–
      renderMenu();
      renderAll();
    })();
  </script>
</body>
</html>
